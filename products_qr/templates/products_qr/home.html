<h1>Товары и QR</h1>

<form id="product-form" method="post">
  {% csrf_token %}
  <label>ID товара:</label>
  <input name="product_id" inputmode="numeric" pattern="\d*" required>
  <button type="submit">Продолжить</button>
</form>

<div id="out" style="margin-top:1rem; white-space:pre-wrap;"></div>

<script>
  // инициализация SDK внутри iframe
  if (window.BX24) {
    BX24.init(function(){ /* готово */ });
  }

  const form = document.getElementById('product-form');
  const out  = document.getElementById('out');

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const id = (form.product_id.value || '').trim();
    if (!/^\d+$/.test(id)) {
      out.textContent = 'Введите числовой ID товара';
      return;
    }

    out.textContent = 'Загружаю товар...';

    // читаем товар как есть (CRM-каталог). Если у вас новый каталог — поменяем на catalog.product.get
    BX24.callMethod('crm.product.get', { id: id }, function (res) {
      if (res.error()) {
        out.textContent = 'Ошибка: ' + res.error() + ' — ' + (res.error_description() || '');
        return;
      }
      const p = res.data();
      if (!p) { out.textContent = 'Товар не найден'; return; }

      // краткий вывод
      let html = `<p><b>${p.NAME || 'Без названия'}</b> (ID ${p.ID})</p>`;
      if (p.PRICE) html += `<p>Цена: ${p.PRICE} ${p.CURRENCY_ID || ''}</p>`;
      html += `<details><summary>Показать все поля</summary><pre>${JSON.stringify(p, null, 2)}</pre></details>`;
      out.innerHTML = html;
    });
  });
</script>
